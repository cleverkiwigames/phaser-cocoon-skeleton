<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>[[[FULL_NAME]]]</title>

        <!-- `cordova.js` is required for the `deviceready` event. -->
        <script src="cordova.js"></script>

        <script src="js/phaser.min.js"></script>
        <script src="js/debug.js"></script>
        <script src="js/common.js"></script>
        <script src="js/boot.js"></script>
        <script src="js/load.js"></script>
        <script src="js/game.js"></script>
        <script src="js/about.js"></script>
    </head>
    <body style="margin: 0; padding: 0; background-color: black">
        <!-- 
            style="display: none; background-color: white; position: fixed;
            bottom: 0; width: 100%; height: 90px; text-align: center;"> -->
        <div id="dummy-ad"
            style="background-color: white; position: fixed;
            bottom: 0; width: 100%; height: 0; text-align: center;">
            <h1 style="font-family: 'Arial';">ADVERTISEMENT<h1>
        </div>
        <script>
var LOGIN_ERROR = 1;
var LOGIN_CANCEL = 2;
var LOGIN_SUCCES = 3;

var SOCIAL; // FIXME needs to be loaded before its used.
var PLATFORM;
var INTERSTITIAL = {
    intrst: null,
    countdown: 0,
    countdownLen: 50,

    createFrom: function (intrst) {
        this.fade = GAME.add.graphics(0, 0);
        this.fade.visible = false;

        intrst.on("load", function(){
           console.log("loaded interstitial");
        });
        intrst.on("fail", function(e){
           console.log("interst failed to load: "+JSON.stringify(e.message));
        });
        intrst.on("show", function(){
           console.log("interst shown a modal content");
        });
        intrst.on("dismiss", function(){
           console.log("interst dismissed the modal content");
        });
        intrst.on("click", function(){
           console.log("interst clicked");
        });
        intrst.load();
        this.intrst = intrst;
    },

    prepare: function () {
        if (this.intrst && this.intrst.isReady() && this.countdown == 0) {
            this.countdown = this.countdownLen;
            this.fade.visible = true;
        }
    },

    update: function () {
        if (this.countdown > 0) {
            this.fade.alpha = 1 - this.countdown/this.countdownLen;

            this.countdown--;

            // We show the ad just a bit before we finish fading because it
            // takes a small amount of time for the ad to load.
            if (this.countdown == 5) {
                this.show();
            }
            if (this.countdown == 0) {
                this.fade.visible = false;
            }
        }
    },

    show: function () {
        if (this.intrst && this.intrst.isReady()) {
            this.interst.show();
            this.interst.load();
        }
    },
};

var BANNER = {
    load: function () {
        this.show();
    },
    hide: function () {
        document.getElementById('dummy-ad').style.height = '0';
    },
    show: function () {
        document.getElementById('dummy-ad').style.height = '90px';
    },
};
// http://damien.antipa.at/blog/2014/02/08/3-ways-to-detect-that-your-application-is-running-in-cordova-slash-phonegap/
var FAKE_MOBILE = true;
var CORDOVA = !!window.cordova;
if (CORDOVA) {
    document.addEventListener("deviceready", function() {
        Cocoon.Ad.configure(
            DEBUGGING ?
            {}:
            {
                ios: {
                    banner: "3de1cd4c5ac64b6a808edffa822f8567",
                    interstitial: "e1681d122d7e4f959815c907ca8db541"
                },
                android: {
                    banner: "3de1cd4c5ac64b6a808edffa822f8567",
                    interstitial: "e1681d122d7e4f959815c907ca8db541"
                }
            }
        );

        var banner;
        // TODO Check if purchased.
        if (!true) { // is not test device
            banner = Cocoon.Ad.createBanner();
            banner.on("load", function(){
               console.log("banner loaded");
               banner.show();
            });
            banner.on("fail", function(e){
               console.error("banner failed to load: " + JSON.stringify(e.message));
            });
            banner.on("show", function(){
               console.log("banner shown");
            });
            banner.on("dismiss", function(){
               console.log("dismissed banner");
            });
            banner.on("click", function(){
               console.log("clicked banner");
            });
        }
        banner.load();

        INTERSTITIAL.createFrom(Cocoon.Ad.createInterstitial());

        PLATFORM = Cocoon.getPlatform();
        if (PLATFORM === 'android') {
            SOCIAL = Cocoon.Social.GooglePlayGames.init(
                {
                    defaultLeaderboard: "[[[PLAY_LEADERBOARD_ID]]]"
                },
                function() {
                    console.log('init complete');
                }
                );
            SOCIAL = Cocoon.Social.GooglePlayGames.getSocialInterface();
        } else if (PLATFORM === 'ios') {
            SOCIAL = Cocoon.Social.GameCenter.init();
            SOCIAL = Cocoon.Social.GameCenter.getSocialInterface();
        } else {
            return;
        }

        function socialLogin(cbk) {
            if (SOCIAL.isLoggedIn()) {
                cbk(LOGIN_SUCCES);
            } else {
                SOCIAL.login(function(loggedIn, error) {
                     if (error) {
                          console.error("login error: " + error.message);
                          cbk(LOGIN_ERROR, error);
                     } else if (loggedIn) {
                          console.log("login succeeded");
                          window.localStorage.setItem('loggedOut', 'no');
                          cbk(LOGIN_SUCCES);
                     } else {
                          console.log("login cancelled");
                          window.localStorage.setItem('loggedOut', 'yes');
                          cbk(LOGIN_CANCEL);
                     }
                });
            }
        }

        if (window.localStorage.getItem('loggedOut') !== 'yes') {
            socialLogin(function(){});
        }

        loadState.start();
    });
} else if (FAKE_MOBILE) {
    // TODO Check if purchased.
    BANNER.show();
} else {
    BANNER.show = function () {};
    loadState.start();
}

        </script>
        <!--<div style="width: 50%; height: 300px;" id="cvs"></div>-->
        <script type="text/javascript">
var DIV;
// var DIV = document.getElementById('cvs');

var scrnDim = {width: window.innerWidth, height: window.innerHeight};
if (DIV) {
    scrnDim = {width: DIV.clientWidth, height: DIV.clientHeight};
}

// TODO Remove ad height from height.
var DIMS = scale({width: 640, height: 920}, scrnDim);

var GAME = new Phaser.Game(
    DIMS.game.outer.width,
    DIMS.game.outer.height,
    Phaser.AUTO, // TODO Check AUTO vs CANVAS w/ different browsers/Cocoon.io.
    DIV ? DIV : undefined
);

window.onresize = onResize;

[
    ['boot', bootState],
    ['load', loadState],
    ['game', gameState],
    ['about', aboutState],
].forEach(function (state) {
    GAME.state.add(state[0], state[1]);
});

GAME.state.start('boot');
        </script>
    </body>
</html>
