<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>[[[FULL_NAME]]]</title>

        <!-- `cordova.js` is required for the `deviceready` event. -->
        <script src="cordova.js"></script>

        <script src="js/phaser.min.js"></script>
        <script src="js/debug.js"></script>
        <script src="js/common.js"></script>
        <script src="js/boot.js"></script>
        <script src="js/load.js"></script>
        <script src="js/game.js"></script>
        <script src="js/about.js"></script>
    </head>
    <body style="margin: 0; padding: 0; background-color: black">
        <script>
var LOGIN_ERROR = 1;
var LOGIN_CANCEL = 2;
var LOGIN_SUCCES = 3;

var SOCIAL; // FIXME needs to be loaded before its used.
var PLATFORM;
var INTERSTITIAL = {
    intrst: null,
    countdown: 0,
    countdownLen: 50,

    createFrom: function (intrst) {
        this.fade = game.add.graphics(0, 0);
        this.fade.visible = false;

        this.intrst = intrst;
        this.intrst.on("load", function(){
           console.log("loaded interstitial");
        });
        this.intrst.on("fail", function(e){
           console.log("interst failed to load: "+JSON.stringify(e.message));
        });
        this.intrst.on("show", function(){
           console.log("interst shown a modal content");
        });
        this.intrst.on("dismiss", function(){
           console.log("interst dismissed the modal content");
        });
        this.intrst.on("click", function(){
           console.log("interst clicked");
        });
        this.intrst.load();
    },

    prepare: function () {
        if (this.intrst && this.intrst.isReady() && this.countdown == 0) {
            this.countdown = this.countdownLen;
            this.fade.visible = true;
        }
    },

    update: function () {
        if (this.countdown > 0) {
            this.fade.alpha = 1 - this.countdown/this.countdownLen;

            this.countdown--;

            // We show the ad just a bit before we finish fading because it
            // takes a small amount of time for the ad to load.
            if (this.countdown == 5) {
                this.show();
            }
            if (this.countdown == 0) {
                this.fade.visible = false;
            }
        }
    },

    show: function () {
        if (this.intrst && this.intrst.isReady()) {
            this.interst.show();
            this.interst.load();
        }
    },
};

// http://stackoverflow.com/a/10566220
if (navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/i)) {
  document.addEventListener("deviceready", function() {
      Cocoon.Ad.configure(
          DEBUGGING ?
          {}:
          {
              ios: {
                  banner: "3de1cd4c5ac64b6a808edffa822f8567",
                  interstitial: "e1681d122d7e4f959815c907ca8db541"
              },
              android: {
                  banner: "3de1cd4c5ac64b6a808edffa822f8567",
                  interstitial: "e1681d122d7e4f959815c907ca8db541"
              }
          }
      );

      var banner = Cocoon.Ad.createBanner();
      banner.on("load", function(){
         console.log("banner loaded");
         banner.show();
      });
      banner.on("fail", function(e){
         console.error("banner failed to load: " + JSON.stringify(e.message));
      });
      banner.on("show", function(){
         console.log("banner shown");
      });
      banner.on("dismiss", function(){
         console.log("dismissed banner");
      });
      banner.on("click", function(){
         console.log("clicked banner");
      });
      banner.load();

      INTERSTITIAL.createFrom(Cocoon.Ad.createInterstitial());

      PLATFORM = Cocoon.getPlatform();
      if (PLATFORM === 'android') {
          SOCIAL = Cocoon.Social.GooglePlayGames.init(
              {
                  defaultLeaderboard: "[[[PLAY_LEADERBOARD_ID]]]"
              },
              function() {
                  console.log('init complete');
              }
              );
          SOCIAL = Cocoon.Social.GooglePlayGames.getSocialInterface();
      } else if (PLATFORM === 'ios') {
          SOCIAL = Cocoon.Social.GameCenter.init();
          SOCIAL = Cocoon.Social.GameCenter.getSocialInterface();
      } else {
          return;
      }

      function socialLogin(cbk) {
          if (SOCIAL.isLoggedIn()) {
              cbk(LOGIN_SUCCES);
          } else {
              SOCIAL.login(function(loggedIn, error) {
                   if (error) {
                        console.error("login error: " + error.message);
                        cbk(LOGIN_ERROR, error);
                   } else if (loggedIn) {
                        console.log("login succeeded");
                        window.localStorage.setItem('loggedOut', 'no');
                        cbk(LOGIN_SUCCES);
                   } else {
                        console.log("login cancelled");
                        window.localStorage.setItem('loggedOut', 'yes');
                        cbk(LOGIN_CANCEL);
                   }
              });
          }
      }

      if (window.localStorage.getItem('loggedOut') !== 'yes') {
          socialLogin(function(){});
      }

      loadState.start();
  });
} else {
    loadState.start();
}

        </script>
        <div id="cvs"></div>
        <script type="text/javascript">
var GAME_INNER_WIDTH = 640;
var GAME_INNER_HEIGHT = 920;

var SCREEN_WIDTH = window.innerWidth;
var SCREEN_HEIGHT = window.innerHeight;

var SCREEN_GAME_RATIO = Math.min(SCREEN_WIDTH/GAME_INNER_WIDTH, SCREEN_HEIGHT/GAME_INNER_HEIGHT);

var GAME_OUTER_HEIGHT = SCREEN_HEIGHT*SCREEN_GAME_RATIO;
var GAME_VPAD = GAME_OUTER_HEIGHT-GAME_INNER_HEIGHT;

var GAME_OUTER_WIDTH = SCREEN_WIDTH*SCREEN_GAME_RATIO;
var GAME_HPAD = GAME_OUTER_WIDTH-GAME_INNER_WIDTH;

console.log("screen dimens: (" + SCREEN_WIDTH + ", " + SCREEN_HEIGHT + ")");
console.log("game inner dimens: (" + GAME_INNER_WIDTH + ", " + GAME_INNER_HEIGHT + ")");
console.log("game outer dimens: (" + GAME_OUTER_WIDTH + ", " + GAME_OUTER_HEIGHT + ")");

var game = new Phaser.Game(GAME_OUTER_WIDTH, GAME_OUTER_HEIGHT, Phaser.AUTO, 'cvs');

game.state.add('boot', bootState);
game.state.add('load', loadState);
game.state.add('game', gameState);
game.state.add('about', aboutState);

game.state.start('boot');
        </script>
    </body>
</html>
